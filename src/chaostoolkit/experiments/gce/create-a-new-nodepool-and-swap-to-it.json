{
    "version": "1.0.0",
    "title": "Does switching a GCE Nodepool impact our availability?",
    "description": "Assuming a swap of a nodepool to another, what is the impact on our system?",
    "tags": [
        "kubernetes",
        "gce",
        "cloudnative"
    ],
    "configuration": {
        "gce_project_id": "terraform-gke-214608",
        "gce_cluster_name": "chaos-cluster",
        "gce_region": "europe-west2",
        "gce_zone": "europe-west2-a"
    },
    "secrets": {
        "gce": {
            "service_account_file": "../account.json"
        }
    },
    "steady-state-hypothesis": {
        "title": "Function is available",
        "probes": [
            {
                "type": "probe",
                "name": "function-must-respond",
                "tolerance": 200,
                "provider": {
                    "type": "http",
                    "url": "http://35.242.149.192:80/productpage"
                }
            }
        ]
    },
    "method": [
        {
            "type": "action",
            "name": "simulate-user-traffic-under-moderate-load",
            "background": true,
            "provider": {
                "type": "process",
                "path": "vegeta",
                "arguments": "attack -targets=targets.txt -workers=5 -rate=10 -timeout=3s -duration=130s -output=result.bin"
            }
        },
        {
            "type": "action",
            "name": "create-a-new-nodepool-and-swap-to-it",
            "provider": {
                "type": "python",
                "module": "chaosgce.nodepool.actions",
                "func": "swap_nodepool",
                "secrets": ["gce"],
                "arguments": {
                    "old_node_pool_id": "default-pool",
                    "delete_old_node_pool": false,
                    "new_nodepool_body": {
                        "nodePool": {
                            "name": "yet-another-pool",
                            "management": {},
                            "initialNodeCount": 1,
                            "version": "1.9.7-gke.6",
                            "config": {
                                "diskSizeGb": 100,
                                "imageType": "COS",
                                "machineType": "n1-standard-1",
                                "oauthScopes": [
                                    "https://www.googleapis.com/auth/devstorage.read_only",
                                    "https://www.googleapis.com/auth/logging.write",
                                    "https://www.googleapis.com/auth/monitoring",
                                    "https://www.googleapis.com/auth/service.management.readonly",
                                    "https://www.googleapis.com/auth/servicecontrol",
                                    "https://www.googleapis.com/auth/trace.append",
                                    "https://www.googleapis.com/auth/compute"
                                ],
                                "serviceAccount": "default"
                            }
                        }
                    }
                }
            }
        }
    ],
    "rollbacks": [
        {
            "type": "action",
            "name": "uncordon-old-nodepool",
            "provider": {
                "type": "python",
                "module": "chaosk8s.node.actions",
                "func": "uncordon_node",
                "arguments": {
                    "label_selector": "cloud.google.com/gke-nodepool=default-pool"
                }
            },
            "pauses": {
                "after": 20
            }
        },
        {
            "type": "action",
            "name": "delete-new-nodepool",
            "provider": {
                "type": "python",
                "module": "chaosgce.nodepool.actions",
                "func": "delete_nodepool",
                "secrets": ["gce"],
                "arguments": {
                    "node_pool_id": "yet-another-pool"
                }
            }
        }
    ]
}
